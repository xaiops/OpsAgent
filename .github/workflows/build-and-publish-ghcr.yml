name: Build and Push OpsAgent to GHCR

on:
  push:
    branches:
      - main
    paths:
      - 'Containerfile'
      - 'pyproject.toml'
      - 'app/**'
      - 'config.yaml.example'
      - 'langgraph.json'
      - '.github/workflows/build-and-publish-ghcr.yml'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}  # Full repository path

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Note: If using Red Hat UBI base image (registry.redhat.io/ubi9/python-311),
      # you may need to add Red Hat Registry login here with secrets:
      # - REDHAT_REGISTRY_USERNAME
      # - REDHAT_REGISTRY_PASSWORD
      # For public base images (docker.io/python:3.11), this is not needed.

      - name: Set up image tags
        id: meta
        run: |
          # Generate tags: latest, git SHA, and version if available
          # Convert to lowercase for container registry compatibility
          IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_BASE="${{ env.REGISTRY }}/${IMAGE_NAME_LOWER}"
          TAGS="${IMAGE_BASE}:latest,${IMAGE_BASE}:${{ github.sha }}"
          
          # If this is a version tag (v1.2.3), add semantic version tags
          if [[ "${{ github.ref }}" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            TAGS="${TAGS},${IMAGE_BASE}:${VERSION}"
            TAGS="${TAGS},${IMAGE_BASE}:v${VERSION}"
          fi
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "image_base=${IMAGE_BASE}" >> $GITHUB_OUTPUT
          echo "package_name=$(basename ${IMAGE_NAME_LOWER})" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push container image
        run: |
          # Build the image
          IMAGE_TAGS="${{ steps.meta.outputs.tags }}"
          
          # Split tags into array
          IFS=',' read -ra TAG_ARRAY <<< "$IMAGE_TAGS"
          
          # Build with first tag
          echo "Building image with tag: ${TAG_ARRAY[0]}"
          podman build \
            --file Containerfile \
            --tag "${TAG_ARRAY[0]}" \
            --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --label "org.opencontainers.image.title=OpsAgent Multi-Agent System" \
            --label "org.opencontainers.image.description=LangGraph multi-agent DevOps system with MCP integration for Ansible, OpenShift, and Terraform" \
            .
          
          # Tag with additional tags
          for tag in "${TAG_ARRAY[@]:1}"; do
            echo "Tagging image: ${tag}"
            podman tag "${TAG_ARRAY[0]}" "${tag}"
          done
          
          # Push all tags
          for tag in "${TAG_ARRAY[@]}"; do
            echo "Pushing image: ${tag}"
            podman push "${tag}"
          done

      - name: Package published successfully
        run: |
          echo "âœ… Package published successfully!"
          echo ""
          echo "ðŸ“¦ Package Information:"
          echo "Registry: ${{ env.REGISTRY }}"
          echo "Repository: ${{ github.repository }}"
          echo "Package: ${{ steps.meta.outputs.package_name }}"
          echo ""
          echo "ðŸ·ï¸ Available Tags:"
          echo "  Latest: ${{ steps.meta.outputs.image_base }}:latest"
          echo "  SHA: ${{ steps.meta.outputs.image_base }}:${{ github.sha }}"
          echo ""
          echo "ðŸ“‹ Usage Examples:"
          echo "  # Pull latest version"
          echo "  podman pull ${{ steps.meta.outputs.image_base }}:latest"
          echo ""
          echo "  # Pull by commit SHA"
          echo "  podman pull ${{ steps.meta.outputs.image_base }}:${{ github.sha }}"
          echo ""
          echo "ðŸ”§ To make this package PUBLIC (one-time step):"
          echo "1. Visit: https://github.com/${{ github.repository }}/pkgs/container/${{ steps.meta.outputs.package_name }}/settings"
          echo "2. Scroll to 'Danger Zone'"
          echo "3. Click 'Change visibility' â†’ Select 'Public'"
          echo "4. Type package name to confirm"
          echo ""
          echo "ðŸ”— Package URL: https://github.com/${{ github.repository }}/pkgs/container/${{ steps.meta.outputs.package_name }}"

      - name: Test package accessibility
        continue-on-error: true
        run: |
          echo "ðŸ§ª Testing package accessibility..."
          
          # Logout to test public access
          podman logout ${{ env.REGISTRY }} || true
          
          # Wait a moment for package to be available
          sleep 5
          
          # Try to pull without authentication
          if podman pull ${{ steps.meta.outputs.image_base }}:latest 2>&1; then
            echo "âœ… Package is publicly accessible!"
          else
            echo "â„¹ï¸ Package is currently PRIVATE"
            echo "ðŸ“ Follow the instructions above to make it public (one-time step)"
          fi

      - name: Create deployment summary
        run: |
          echo "## ðŸš€ OpsAgent Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Image Tags Created" >> $GITHUB_STEP_SUMMARY
          echo "| Tag Type | Value | Full Image Reference |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|---------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Latest | \`latest\` | \`${{ steps.meta.outputs.image_base }}:latest\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit SHA | \`${{ github.sha }}\` | \`${{ steps.meta.outputs.image_base }}:${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“¦ Package Registry](https://github.com/${{ github.repository }}/pkgs/container/${{ steps.meta.outputs.package_name }})" >> $GITHUB_STEP_SUMMARY
          echo "- [âš™ï¸ Package Settings](https://github.com/${{ github.repository }}/pkgs/container/${{ steps.meta.outputs.package_name }}/settings)" >> $GITHUB_STEP_SUMMARY
          echo "- [ðŸ“‹ Repository](https://github.com/${{ github.repository }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”§ Make Package Public (One-Time)" >> $GITHUB_STEP_SUMMARY
          echo "1. Visit [Package Settings](https://github.com/${{ github.repository }}/pkgs/container/${{ steps.meta.outputs.package_name }}/settings)" >> $GITHUB_STEP_SUMMARY
          echo "2. Scroll to **Danger Zone**" >> $GITHUB_STEP_SUMMARY
          echo "3. Click **Change visibility** â†’ Select **Public**" >> $GITHUB_STEP_SUMMARY
          echo "4. Type package name to confirm" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“– Usage" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "# Pull latest" >> $GITHUB_STEP_SUMMARY
          echo "podman pull ${{ steps.meta.outputs.image_base }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Deploy to OpenShift" >> $GITHUB_STEP_SUMMARY
          echo "oc set image deployment/ops-agent \\" >> $GITHUB_STEP_SUMMARY
          echo "  ops-agent=${{ steps.meta.outputs.image_base }}:latest \\" >> $GITHUB_STEP_SUMMARY
          echo "  -n xaiops" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

