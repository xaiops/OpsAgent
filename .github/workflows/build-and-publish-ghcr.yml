name: Build and Push OpsAgent to GHCR

on:
  push:
    branches:
      - main
    paths:
      - 'Containerfile'
      - 'pyproject.toml'
      - 'app/**'
      - 'config.yaml.example'
      - 'langgraph.json'
      - '.github/workflows/build-and-publish-ghcr.yml'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}  # Full repository path

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Note: If using Red Hat UBI base image (registry.redhat.io/ubi9/python-311),
      # you may need to add Red Hat Registry login here with secrets:
      # - REDHAT_REGISTRY_USERNAME
      # - REDHAT_REGISTRY_PASSWORD
      # For public base images (docker.io/python:3.11), this is not needed.

      - name: Set up image tags
        id: meta
        run: |
          # Generate tags: latest, git SHA, and version if available
          # Convert to lowercase for container registry compatibility
          IMAGE_NAME_LOWER=$(echo "${{ env.IMAGE_NAME }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_BASE="${{ env.REGISTRY }}/${IMAGE_NAME_LOWER}"
          TAGS="${IMAGE_BASE}:latest,${IMAGE_BASE}:${{ github.sha }}"
          
          # If this is a version tag (v1.2.3), add semantic version tags
          if [[ "${{ github.ref }}" =~ ^refs/tags/v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
            TAGS="${TAGS},${IMAGE_BASE}:${VERSION}"
            TAGS="${TAGS},${IMAGE_BASE}:v${VERSION}"
          fi
          
          echo "tags=${TAGS}" >> $GITHUB_OUTPUT
          echo "image_base=${IMAGE_BASE}" >> $GITHUB_OUTPUT
          echo "package_name=$(basename ${IMAGE_NAME_LOWER})" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push container image
        run: |
          # Build the image
          IMAGE_TAGS="${{ steps.meta.outputs.tags }}"
          
          # Split tags into array
          IFS=',' read -ra TAG_ARRAY <<< "$IMAGE_TAGS"
          
          # Build with first tag
          echo "Building image with tag: ${TAG_ARRAY[0]}"
          podman build \
            --file Containerfile \
            --tag "${TAG_ARRAY[0]}" \
            --label "org.opencontainers.image.source=https://github.com/${{ github.repository }}" \
            --label "org.opencontainers.image.revision=${{ github.sha }}" \
            --label "org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --label "org.opencontainers.image.title=OpsAgent Multi-Agent System" \
            --label "org.opencontainers.image.description=LangGraph multi-agent DevOps system with MCP integration for Ansible, OpenShift, and Terraform" \
            .
          
          # Tag with additional tags
          for tag in "${TAG_ARRAY[@]:1}"; do
            echo "Tagging image: ${tag}"
            podman tag "${TAG_ARRAY[0]}" "${tag}"
          done
          
          # Push all tags
          for tag in "${TAG_ARRAY[@]}"; do
            echo "Pushing image: ${tag}"
            podman push "${tag}"
          done

      - name: Make package public
        continue-on-error: true
        run: |
          # Wait for package to be fully registered in GHCR
          echo "‚è≥ Waiting for package to be registered in GitHub Container Registry..."
          sleep 20
          
          PACKAGE_NAME="${{ steps.meta.outputs.package_name }}"
          OWNER="${{ github.repository_owner }}"
          
          echo "üì¶ Package name: ${PACKAGE_NAME}"
          echo "üë§ Owner: ${OWNER}"
          echo ""
          
          # Function to try setting visibility
          set_visibility() {
            local endpoint=$1
            local label=$2
            
            echo "Trying ${label} endpoint: ${endpoint}"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" \
              -X PATCH \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "${endpoint}" \
              -d '{"visibility":"public"}' 2>&1)
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | head -n -1)
            
            echo "  HTTP Code: ${HTTP_CODE}"
            
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "204" ]; then
              echo "  ‚úÖ Success!"
              return 0
            else
              echo "  ‚ùå Failed: ${BODY}"
              return 1
            fi
          }
          
          # Try organization endpoint first
          if set_visibility "https://api.github.com/orgs/${OWNER}/packages/container/${PACKAGE_NAME}" "organization"; then
            echo ""
            echo "‚úÖ Package visibility set to PUBLIC via organization endpoint!"
            echo "üéâ Future builds will push to the same public package automatically."
            exit 0
          fi
          
          echo ""
          
          # Try user endpoint as fallback
          if set_visibility "https://api.github.com/user/packages/container/${PACKAGE_NAME}" "user"; then
            echo ""
            echo "‚úÖ Package visibility set to PUBLIC via user endpoint!"
            echo "üéâ Future builds will push to the same public package automatically."
            exit 0
          fi
          
          # Both failed - provide clear manual instructions
          echo ""
          echo "‚ö†Ô∏è  Automatic visibility change failed."
          echo "This is a ONE-TIME manual step needed:"
          echo ""
          echo "  1. Visit: https://github.com/${OWNER}?tab=packages"
          echo "  2. Click on the '${PACKAGE_NAME}' package"
          echo "  3. Click 'Package settings' (right side)"
          echo "  4. Scroll to 'Danger Zone'"
          echo "  5. Click 'Change visibility' ‚Üí Select 'Public'"
          echo "  6. Type package name to confirm"
          echo ""
          echo "After this one-time change, all future builds will work automatically!"

      - name: Output image details
        run: |
          echo "‚úÖ Successfully built and pushed images:"
          echo "${{ steps.meta.outputs.tags }}" | tr ',' '\n' | while read tag; do
            echo "  üì¶ ${tag}"
          done
          
          echo ""
          echo "üöÄ To pull the image:"
          echo "  podman pull ${{ steps.meta.outputs.image_base }}:latest"
          echo ""
          echo "üîó View on GHCR:"
          echo "  https://github.com/${{ github.repository }}/pkgs/container/${{ steps.meta.outputs.package_name }}"
          
          echo ""
          echo "üìù Deploy to OpenShift:"
          echo "  oc new-app ${{ steps.meta.outputs.image_base }}:latest --name=ops-agent"

